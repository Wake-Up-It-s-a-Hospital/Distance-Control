
# 📡 Distance-Control: UWB 기반 거리 측정 & AWS IoT 연동 시스템

   

**Distance-Control**은 UWB 모듈(DWM1000)을 사용해 **태그(Tag)**와 **앵커(Anchor)** 간의 거리를 실시간으로 측정하고,

AWS IoT와 연동하여 원격 모드 제어, 분실 알림 등 확장 기능을 제공하는 프로젝트입니다.

본 레포지토리는 2025년 한국공학대학교 종합설계(캡스톤디자인) 프로젝트의 일부로서 개발되었습니다.

---

## 🛠️ 현재까지 구현된 기능

- ✅ **UWB 거리 측정 (TWR 방식)**
    
    태그 ↔ 앵커 간 POLL → POLL_ACK → RANGE → RANGE_REPORT 시퀀스를 이용해 cm 단위 거리 계산.
    
- ✅ **태그 & 앵커 역할 분리**
    - 태그: 거리 측정 시작, 결과 수신
    - 앵커: 응답 및 거리 계산 후 결과 송신
- ✅ **통신 안정성 관리**
    
    타임아웃 시 자동 재시작 또는 재부팅으로 시스템 멈춤 방지.
    
- ✅ **노이즈 보정**
    
    앵커 쪽에서 칼만 필터(SimpleKalmanFilter)로 튀는 값 완화.
    
- ✅ **측정 속도 모니터링**
    
    1초당 성공 측정 횟수를 표시하여 성능 파악.
    
- ✅ **AWS IoT 연동**
    - 원격 모드 전환(수동/자동)
    - 분실 알림(부저 작동)
    - 장치 상태 주기 전송

---

## 📁 프로젝트 파일 구조
bash
복사편집
Distance-Control/
├── src/
│   ├── dwm1000_tag/           # 태그 펌웨어
│   │   └── dwm1000_tag.ino
│   ├── dwm1000_anchor/        # 앵커 펌웨어
│   │   └── anchor_final_v0.ino
│   ├── wearable_on_aws/       # AWS IoT 연동 코드
│   │   └── aws_tag_integration_v1.ino
│   └── main.cpp               # 예제/테스트 코드
├── platformio.ini             # PlatformIO 빌드 설정
└── README.md


## Distance-Control 기능 요약

1. **UWB 거리 측정**
    - 태그(이동 장치)와 앵커(고정 장치) 사이의 거리를 실시간으로 측정합니다.
    - 정밀한 시간 차이 계산(TWR 방식)으로 cm 단위 거리 산출이 가능합니다.
2. **태그 & 앵커 역할 분리**
    - **태그**: 거리 측정을 시작하는 장치. 주기적으로 신호를 보내고 결과를 수신합니다.
    - **앵커**: 태그 신호를 받아 응답하고, 거리 계산을 수행하여 결과를 전달합니다.
3. **통신 안정성 관리**
    - 통신이 멈추거나 일정 시간 응답이 없으면 자동으로 재시작 또는 재부팅하여 시스템이 멈추지 않게 유지합니다.
4. **노이즈 보정**
    - 앵커 쪽에서 칼만 필터를 적용해 거리값이 튀는 현상을 줄이고 안정된 측정 결과를 제공합니다.
5. **측정 속도 모니터링**
    - 1초에 몇 번 거리 측정이 성공했는지를 계산해 샘플링 속도를 표시합니다.
6. **AWS IoT 연동**
   - **원격 모드 전환**: AWS MQTT 메시지로 태그 모드를 *수동/자동* 변경.
   - **환자 lost 알림**: lost 상황 인지시 부저가 울려 알림.
   - **동기화**:  모드상태를 led 출력상태와 동기화.
# 개요

- **프로토콜**: 태그(Tag) ↔ 앵커(Anchor) 사이에 **POLL → POLL_ACK → RANGE → RANGE_REPORT** 시퀀스로 **쌍방 대칭(TWR) 거리측정**.
- **감시/안정화**: UWB 통신 정지 감지(워치독)와 타임아웃 시 **수신 재시작 또는 리셋**.


### 앵커 핀맵 (ESP32 ↔ DWM1000)
- **SPI**
    - `PIN_MOSI = 23`
    - `PIN_MISO = 19`
    - `PIN_SCK = 12`
    - `PIN_SS = 14` *(Chip Select)*
- **제어**
    - `PIN_IRQ = 13`
    - `PIN_RST = 15`

### 태그 핀맵 (ESP32 ↔ DWM1000)
- **SPI**
    - `PIN_MOSI = 17`
    - `PIN_MISO = 16`
    - `PIN_SCK = 4`
    - `PIN_SS = 5`
- **제어**
    - `PIN_IRQ = 2`
    - `PIN_RST = 15`

# 작동법
1. **앵커 전원 인가**
    - 시리얼 모니터로 부팅 로그가 뜨는지 확인(보오율115200).
2. **태그 전원 인가**
    - 태그가 폴링(POLL)하고 앵커가 응답하며 **거리 측정값**이 시리얼로 출력됩니다(단위: **m**).
3. **거리 확인**
    - Serial Monitor 에 distance 값이 주기적으로 출력됩니다.


https://github.com/user-attachments/assets/f7d7a565-9695-4982-8655-7eac68f521dd







